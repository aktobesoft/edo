{% extends 'index.html' %} {% block form_content %}

<form method="POST" action='{{ request.path }}' novalidate>
  <div id="vue">
    <template>
      <div class="row">
        <div class="col-12">
          <div class="card mt-3">
            <div class="card-header">
              Список процессов согласования
            </div>
            <div class="card-body table-responsive p-0">
              <div class="col-12 ">
                
                <div class="form-group row">

                  <div class="mt-2 ml-1 row">

                    <label for="id" class="col-sm-2 col-form-label mt-2">ИД</label>
                    <div class="col-sm-10 mt-2">
                        <input type="text" name="id" class="form-control" id="id" placeholder="ИД" v-model="approval_process.id" readonly>
                    </div>

                    <label for="id" class="col-sm-2 col-form-label mt-2">Активный</label>
                    <div class="col-sm-10 mt-2">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" v-model="approval_process.is_active">
                      </div>
                    </div>

                    

                    <label for="id" class="col-sm-2 col-form-label mt-2">Организация</label>
                    <div class="col-sm-10 mt-2">
                      <select v-on:click="getEntityList()" v-model="approval_process.entity_iin" class="form-control">
                        <option value="0">---------</option>
                        <option v-for="item in entityList" v-bind:value="item.iin">
                          [[ item.name ]] ([[ item.iin ]])
                        </option>
                      </select>
                    </div>

                    <label for="id" class="col-sm-2 col-form-label mt-2">Шаблон документа</label>
                    <div class="col-sm-10 mt-2">
                      <select v-on:click="getDocumentTypeList()" v-model="approval_process.document_type_id"
                        class="form-control" aria-label="Шаблон документа" id="document_type">
                        <option value="0">---------</option>
                        <option v-for="item in documentType" v-bind:value="item.id">
                          [[ item.description ]]
                        </option>
                      </select>
                    </div>

                    <label for="id" class="col-sm-2 col-form-label mt-2">Статус</label>
                    <div class="col-sm-10 mt-2">
                      <select v-model="approval_process.status" class="form-control">
                        <option value="0">---------</option>
                        <option v-for="item in statusList" v-bind:value="item">
                          [[ item ]]
                        </option>
                      </select>
                    </div>

                    <label for="id" class="col-sm-2 col-form-label mt-2">Дата начало</label>
                    <div class="col-sm-10 mt-2">
                      <input type="datetime-local" name="id" class="form-control" v-model="approval_process.start_date">
                    </div>

                    <label for="id" class="col-sm-2 col-form-label mt-2">Дата конец</label>
                    <div class="col-sm-10 mt-2">
                      <input type="datetime-local" name="id" class="form-control" v-model="approval_process.end_date">
                    </div>

                  </div>
                  <div class="mt-2 mb-2 ml-2">
                    <button v-on:click="clearActiveStep()" type="button" type="button" class="btn btn-success"
                      data-target="#newElementModal" data-toggle="modal">
                      <!--<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square-fill" viewBox="0 0 16 16">
                    <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm6.5 4.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3a.5.5 0 0 1 1 0z"/>
                  </svg>-->
                      Добавить
                    </button>
                  </div>
                  <div class="col-12">
                    <table class="table table-bordered table-hover">
                      <thead class="table-dark">
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col">ID</th>
                          <th scope="col">Уровень</th>
                          <th scope="col">Тип</th>
                          <th scope="col">Сотрудник</th>
                          <th scope="col">Операции</th>
                        </tr>
                      </thead>
                      <tbody v-for="(rout, index) in approval_process.routs" :key="index">
                        <tr>
                          <td>[[ index+1 ]]</td>
                          <td>[[ rout.id ]]</td>
                          <td>[[ rout.level ]]</td>
                          <td>[[ rout.type]]</td>
                          <td>[[ rout.employee.name ]] ([[ rout.employee.email ]])</td>
                          <td>
                            <button v-on:click="loadStep(rout, index)" data-toggle="modal"
                              data-target="#newElementModal" class="btn btn-success btn-sm rounded-3" type="button"
                              data-toggle="tooltip" data-placement="top" title="" data-original-title="Edit">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-pencil-fill" viewBox="0 0 16 16">
                                <path
                                  d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z" />
                              </svg>
                            </button>
                            <button v-on:click="deleteStep(rout, index)" class="btn btn-danger btn-sm rounded-3"
                              type="button" data-toggle="tooltip" data-placement="top" title=""
                              data-original-title="Delete">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-trash-fill" viewBox="0 0 16 16">
                                <path
                                  d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z" />
                              </svg>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="pt-3 row">
                    <div class="col mt-2 mb-2 ml-2">
                      <button type="button" class="btn btn-primary " v-on:click="sendData()">
                        <!--<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 448 512">
                    <path d="M433.941 129.941l-83.882-83.882A48 48 0 0 0 316.118 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V163.882a48 48 0 0 0-14.059-33.941zM224 416c-35.346 0-64-28.654-64-64 0-35.346 28.654-64 64-64s64 28.654 64 64c0 35.346-28.654 64-64 64zm96-304.52V212c0 6.627-5.373 12-12 12H76c-6.627 0-12-5.373-12-12V108c0-6.627 5.373-12 12-12h228.52c3.183 0 6.235 1.264 8.485 3.515l3.48 3.48A11.996 11.996 0 0 1 320 111.48z"/>
                  </svg>-->
                        Сохранить
                      </button>
                      <button type="button" class="btn btn-primary btn-danger" data-toggle="modal"
                        data-target="#deleteElementModal">
                        <!--<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                    <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                  </svg>-->
                        Удалить
                      </button>
                    </div>
                  </div>

                  <!-- Новый элемент -->
                  <div class="modal fade" id="newElementModal" tabindex="-1" aria-labelledby="newElementModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="newElementModalLabel">Строка записи</h5>
                          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="pt-2 row">

                            <label for="rout_position" class="col-sm-2 col-form-label">Номер записи</label>
                            <div class="col-sm-10 mt-2">
                              <input type="number" class="form-control" id="rout_position" placeholder="Уровень"
                                v-model.number="rout_position" readonly>
                            </div>

                            <label for="rout_level" class="col-sm-2 col-form-label">Уровень</label>
                            <div class="col-sm-10 mt-2">
                              <input type="number" class="form-control" id="rout_level" placeholder="Уровень"
                                v-model.number="rout_level" min="1" max="100">
                            </div>

                            <label for="rout_level" class="col-sm-2 col-form-label">Тип согласования</label>
                            <div class="col-sm-10 mt-2">
                              <select class="form-control" aria-label="Тип согласования" id="rout_type"
                                v-model="rout_type">
                                <option selected>-------------------</option>
                                <option value="Линейное">Линейное</option>
                                <option value="Паралельное">Паралельное</option>
                              </select>
                            </div>

                            <label for="rout_employee_id" class="col-sm-2 col-form-label">Сотрудник</label>
                            <div class="col-sm-10 mt-2">
                              <select v-on:click="getEmployeeList()" v-model="rout_employee" class="form-control"
                                aria-label="Сотрудник" id="rout_employee">
                                <option value="0">---------</option>
                                <option v-for="item in emloyeeList"
                                  v-bind:value="{ id: item.id, name: item.name, email: item.email }">
                                  [[ item.name ]]
                                </option>
                              </select>
                            </div>

                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                          <button type="button" class="btn btn-primary " role="button" v-on:click="updateStep()"
                            data-dismiss="modal">
                            <!--<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 448 512">
                        <path d="M433.941 129.941l-83.882-83.882A48 48 0 0 0 316.118 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V163.882a48 48 0 0 0-14.059-33.941zM224 416c-35.346 0-64-28.654-64-64 0-35.346 28.654-64 64-64s64 28.654 64 64c0 35.346-28.654 64-64 64zm96-304.52V212c0 6.627-5.373 12-12 12H76c-6.627 0-12-5.373-12-12V108c0-6.627 5.373-12 12-12h228.52c3.183 0 6.235 1.264 8.485 3.515l3.48 3.48A11.996 11.996 0 0 1 320 111.48z"/>
                      </svg>-->
                            Сохранить
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Сохранение записи -->
                  <div class="modal fade" id="deleteElementModal" tabindex="-1"
                    aria-labelledby="deleteElementModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="deleteElementModalLabel">Подтвердите действие</h5>
                          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Вы действительно хотите удалить запись?
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                          <button type="button" class="btn btn-primary btn-danger" data-dismiss="modal"
                            v-on:click="deleteAproovalTemplate()">
                            <!--<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                        <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                      </svg>-->
                            Удалить
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>
</form>

<script>
  new Vue({
    delimiters: ['[[', ']]'],
    el: '#vue',
    data: {
      approval_process: {
        "id": 0,
        "is_active": true,
        "document_id": 0,
        "document_type_id": 0,
        "entity_iin": "",
        "approval_template_id": 0,
        "status": "В работе",
        "start_date": "",
        "end_date": "",
        "document": {
          "number": "",
          "date": ""
        },
        "document_type": {
          "id": 4,
          "name": "",
          "description": ""
        },
        "entity": {
          "id": 0,
          "iin": "",
          "name": ""
        },
        "approval_template": {
          "id": 0,
          "document_type_id": 0,
          "name": ""
        },
        "routes": [],
      },
      approval_process_id: "{{itemId}}",
      emloyeeList: [],
      entityList: [],
      documentType: [],
      statusList: ['В работе', 'Подписан', 'Отклонен', 'Отменен', 'В работе', 'Черновик'],
      rout_employee: '',
      rout_type: '',
      rout_level: 0,
      rout_index: -1,
      rout_position: 0,
    },
    async mounted() {
      if (this.approval_process_id != 'new') {
        await this.getAproovalTemplate()

      }
      await this.getEmployeeList()
      await this.getEntityList()
      await this.getDocumentTypeList()

    },
    methods: {
      getAproovalTemplate: async function () {
        console.log(Vue.version);
        try {
          let response = await axios.get("{{url_for('get_approval_process_list')}}" + this.approval_process_id + "?nested=true");
          console.log(response.data)
          this.approval_process = response.data
          return response
        } catch (err) {
          console.log(err)
          return null
        }
      },
      collectData: function () {
        approval_process_routs = []
        approval_process_dict = {}
        this.approval_process.routs.forEach((element) => {
          routDict = {
            'id': parseInt(element.id),
            'level': element.level,
            'type': element.type,
            'employee_id': element.employee_id,
            'hash': ''
          }
          approval_process_routs.push(routDict)
        })
        approval_process_dict = {
          "id": this.approval_process_id,
          "document_type_id": this.approval_process.document_type_id,
          "name": this.approval_process.name,
          "entity_iin": this.approval_process.entity_iin,
          "routs": approval_process_routs
        }
        console.log(this.document_type_id);
        return approval_process_dict
      },
      postAproovalTemplate: async function () {
        approval_process_dict = this.collectData()
        console.log(Vue.version);
        try {
          let response = await axios.post("{{url_for('get_approval_process_list')}}", approval_process_dict);
          console.log(response.data)
          this.approval_process = response.data
          this.approval_process_id = this.approval_process['id']
          return response
        } catch (err) {
          console.log(err)
          return null
        }
      },

      putAproovalTemplate: async function () {
        approval_process_dict = this.collectData()
        console.log("before send")
        console.log(approval_process_dict);
        try {
          let response = await axios.put("{{url_for('get_approval_process_list')}}" + this.approval_process_id, approval_process_dict);
          console.log(response.data)
          return response
        } catch (err) {
          console.log(err)
        }
      },
      deleteAproovalTemplate: async function () {
        try {
          let response = await axios.delete("{{url_for('get_approval_process_list')}}" + this.approval_process_id);
          if (response != null && (response.status == 200 || response.status == 201)) {
            this.goToAproovalTemplateList()
          }
        } catch (err) {
          console.log(err)
        }
      },
      goToAproovalTemplateList: function () {
        window.location.href = "{{url_for('approval_process_list')}}"
      },
      clearActiveStep: function () {
        this.rout_employee = '',
          this.rout_type = '',
          this.rout_level = 0,
          this.rout_index = -1
        this.rout_position = this.approval_process.routs.length + 1
      },
      addNewStep: function () {
        this.approval_process.routs.push({
          "id": 0,
          "level": this.rout_level,
          "type": this.rout_type,
          "employee_id": this.rout_employee.id,
          "employee": {
            "id": this.rout_employee.id,
            "name": this.rout_employee.name,
            "email": this.rout_employee.email
          }
        })
      },
      loadStep: function (rout, index) {
        this.rout_level = rout.level;
        this.rout_type = rout.type;
        this.rout_employee.name = rout.employee.name;
        this.rout_employee.id = rout.employee_id;
        this.rout_employee.email = rout.employee.email;
        this.rout_employee = rout.employee
        this.rout_index = index;
        this.rout_position = index + 1;
      },
      updateStep: function () {
        if (this.rout_index == -1) {
          this.addNewStep();
          return
        }
        rout = this.approval_process.routs[this.rout_index]
        rout.level = this.rout_level;
        rout.type = this.rout_type;
        rout.employee_id = this.rout_employee.id;
        rout.employee.name = this.rout_employee.name;
        rout.employee.id = this.rout_employee.id;
        rout.employee.email = this.rout_employee.email;
      },
      deleteStep: function (rout, index) {
        this.approval_process.routs.pop(index);
      },
      getDocumentTypeList: async function () {
        if (this.documentType.length > 0) {
          return
        }
        try {
          let response = await axios.get("{{url_for('get_document_type_list')}}?skip=0&limit=100&")
          console.log("getDocumentTypeList")
          console.log(response.data)
          this.documentType = response.data['result']
        } catch (err) {
          console.log(err)
        }
      },
      getEmployeeList: async function () {
        if (this.emloyeeList.length > 0) {
          return
        }
        try {
          let response = await axios.get("{{url_for('get_employee_list')}}?skip=0&limit=100&")
          console.log(response.data)
          this.emloyeeList = response.data['result']
        } catch (err) {
          console.log(err)
        }
      },
      getEntityList: async function () {
        if (this.entityList.length > 0) {
          return
        }
        try {
          let response = await axios.get("{{url_for('get_entity_list')}}?skip=0&limit=100&nested=false&optional=false")
          console.log(response.data)
          this.entityList = response.data['result']
        } catch (err) {
          console.log(err)
        }
      },
      sendData: async function () {
        if (this.approval_process_id == 'new') {
          let response = await this.postAproovalTemplate()
          if (response != null && (response.status == 200 || response.status == 201)) {
            await this.getAproovalTemplate()
          }
        } else {
          let response = await this.putAproovalTemplate()
          if (response != null && (response.status == 200 || response.status == 201)) {
            await this.getAproovalTemplate()
            $("#success-alert").fadeTo(2000, 500).slideUp(500, function () {
              $("#success-alert").slideUp(500);
            });
          }
        }

      }
    }
  })
</script>

{% endblock %}